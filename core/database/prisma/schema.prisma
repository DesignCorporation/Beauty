// Beauty Platform Database Schema
// Domain-Driven Design + Multi-tenant Architecture

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ========================================
// CORE ENTITIES - Business Domain
// ========================================

// User Roles - –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ —Ä–æ–ª–µ–π (LEGACY - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)
enum UserRole {
  SUPER_ADMIN // –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –≤—Å–µ–π –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã
  SALON_OWNER // –í–ª–∞–¥–µ–ª–µ—Ü —Å–∞–ª–æ–Ω–∞
  MANAGER // –ú–µ–Ω–µ–¥–∂–µ—Ä —Å–∞–ª–æ–Ω–∞ (–º–µ–∂–¥—É Owner –∏ Staff)
  STAFF_MEMBER // –ú–∞—Å—Ç–µ—Ä
  RECEPTIONIST // –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä —Ä–µ—Å–µ–ø—à–µ–Ω–∞
  ACCOUNTANT // –ë—É—Ö–≥–∞–ª—Ç–µ—Ä —Å–∞–ª–æ–Ω–∞
  CLIENT // –ö–ª–∏–µ–Ω—Ç —Å–∞–ª–æ–Ω–∞
}

// Tenant-specific Roles - –ù–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞ —Ä–æ–ª–µ–π –¥–ª—è multi-tenant
// –ö–∞–∂–¥—ã–π user –º–æ–∂–µ—Ç –∏–º–µ—Ç—å —Ä–∞–∑–Ω—ã–µ —Ä–æ–ª–∏ –≤ —Ä–∞–∑–Ω—ã—Ö tenant
enum TenantRole {
  OWNER // –í–ª–∞–¥–µ–ª–µ—Ü —Å–∞–ª–æ–Ω–∞ (–ø–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø)
  MANAGER // –ú–µ–Ω–µ–¥–∂–µ—Ä (—É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–µ—Ä—Å–æ–Ω–∞–ª–æ–º –∏ –∑–∞–ø–∏—Å—è–º–∏)
  STAFF // –ú–∞—Å—Ç–µ—Ä (—Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ –∑–∞–ø–∏—Å–∏)
  RECEPTIONIST // –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä (–∑–∞–ø–∏—Å–∏ –∏ –∫–ª–∏–µ–Ω—Ç—ã)
  ACCOUNTANT // –ë—É—Ö–≥–∞–ª—Ç–µ—Ä (—Ñ–∏–Ω–∞–Ω—Å—ã –∏ –æ—Ç—á–µ—Ç—ã)
}

// Status –¥–ª—è —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Å—É—â–Ω–æ—Å—Ç–µ–π
enum EntityStatus {
  ACTIVE
  INACTIVE
  PENDING
  SUSPENDED
  DELETED
}

// Language Support
enum Language {
  RU // –†—É—Å—Å–∫–∏–π
  EN // English
  PL // Polski
  UA // –£–∫—Ä–∞—ó–Ω—Å—å–∫–∞
}

// Issue #82: Staff Specializations
enum StaffSpecializationType {
  BARBER // –ë–∞—Ä–±–µ—Ä
  STYLIST // –°—Ç–∏–ª–∏—Å—Ç
  NAIL_MASTER // –ú–∞—Å—Ç–µ—Ä –º–∞–Ω–∏–∫—é—Ä–∞
  COLORIST // –ö–æ–ª–æ—Ä–∏—Å—Ç
  GROOMER // –ì—Ä—É–º–º–µ—Ä
  MAKEUP_ARTIST // –í–∏–∑–∞–∂–∏—Å—Ç
  MASSAGE_THERAPIST // –ú–∞—Å—Å–∞–∂–∏—Å—Ç
  AESTHETIC_SPECIALIST // –≠—Å—Ç–µ—Ç–æ–ª–æ–≥
  PIERCER // –ü–∏—Ä—Å–µ—Ä
  TATTOO_ARTIST // –¢–∞—Ç—É–∏—Ä–æ–≤—â–∏–∫
}

// Currency Support - –≤–∫–ª—é—á–∞–µ–º RUB –≤—Ä–µ–º–µ–Ω–Ω–æ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
enum Currency {
  USD // US Dollar
  EUR // Euro
  PLN // –ü–æ–ª—å—Å–∫–∏–π –∑–ª–æ—Ç—ã–π
  UAH // –£–∫—Ä–∞–∏–Ω—Å–∫–∞—è –≥—Ä–∏–≤–Ω–∞
  RUB // –†–æ—Å—Å–∏–π—Å–∫–∏–π —Ä—É–±–ª—å (deprecated, –Ω–æ –Ω—É–∂–µ–Ω –¥–ª—è –º–∏–≥—Ä–∞—Ü–∏–∏)
}

// –¢–∏–ø—ã —Å–∞–ª–æ–Ω–æ–≤ –¥–ª—è –ø—Ä–µ—Å–µ—Ç–æ–≤ —É—Å–ª—É–≥/–∫–∞—Ç–µ–≥–æ—Ä–∏–π
enum SalonType {
  HAIR
  NAILS
  MASSAGE
  BARBERSHOP
  PET_GROOMING
  WELLNESS
  COSMETOLOGY
  BROW_LASH
  MIXED
}

// ========================================
// TENANTS - –ú—É–ª—å—Ç–∏—Ç–µ–Ω–∞–Ω—Ç–Ω–æ—Å—Ç—å
// ========================================

model Tenant {
  id          String  @id @default(cuid())
  slug        String  @unique // URL slug –¥–ª—è —Å–∞–ª–æ–Ω–∞
  name        String
  description String?

  // Contact Info
  email   String?
  phone   String?
  website String?

  // Address
  country    String?
  city       String?
  address    String?
  postalCode String?
  billingCompanyName     String?  @map("billing_company_name")
  billingVatId           String?  @map("billing_vat_id")
  billingUseSalonAddress Boolean  @default(true) @map("billing_use_salon_address")
  billingAddress         String?  @map("billing_address")
  billingCity            String?  @map("billing_city")
  billingPostalCode      String?  @map("billing_postal_code")
  billingCountry         String?  @map("billing_country")

  // Business Settings
  currency  Currency  @default(PLN) // –°—Ç–∞—Ä—Ç—É–µ–º —Å –ü–æ–ª—å—à–∏
  language  Language  @default(RU)
  timezone  String    @default("Europe/Moscow")
  salonType SalonType @default(MIXED)

  // Branding
  logoUrl String? @map("logo_url") // URL –ª–æ–≥–æ—Ç–∏–ø–∞ —Å–∞–ª–æ–Ω–∞

  // Salon Identification (NEW - –¥–ª—è –∑–∞–ø–∏—Å–µ–π –∏ –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–≥–æ invite –∫–æ–¥–∞)
  salonNumber String? @unique @map("salon_number") // –ü–æ—Å—Ç–æ—è–Ω–Ω—ã–π 8-–∑–Ω–∞—á–Ω—ã–π –Ω–æ–º–µ—Ä —Å–∞–ª–æ–Ω–∞

  // Status
  status   EntityStatus @default(ACTIVE)
  isActive Boolean      @default(true)

  // Relationships
  users                User[]
  clients              Client[]
  services             Service[]
  appointments         Appointment[]
  invitations          Invitation[]
  userSalonAccess      UserSalonAccess[]
  notifications        Notification[]
  notificationSettings NotificationSettings[]
  images               Image[] // Tenant-specific –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
  clientSalonRelations ClientSalonRelation[] // Client Portal: —Å–≤—è–∑—å —Å –∫–ª–∏–µ–Ω—Ç–∞–º–∏
  clientInvitations    ClientInvitation[] // Client Portal: –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–æ–≤
  salonInviteCodes     SalonInviteCode[]
  serviceCategories    ServiceCategory[]

  // Multi-Tenant Relationships (NEW)
  owners    TenantOwner[] // –í–ª–∞–¥–µ–ª—å—Ü—ã —Å–∞–ª–æ–Ω–∞ (many-to-many)
  userRoles UserTenantRole[] // –†–æ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ —ç—Ç–æ–º —Å–∞–ª–æ–Ω–µ
  
  // Subscription
  subscription Subscription?

  // Schedule Management (Issue #73)
  salonWorkingHours       SalonWorkingHour[]       @relation("SalonWorkingHours")
  staffWorkingHours       StaffWorkingHour[]       @relation("StaffWorkingHours")
  staffScheduleExceptions StaffScheduleException[] @relation("StaffScheduleExceptions")

  // Audit
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  StaffServiceMap StaffServiceMap[]

  @@map("tenants")
}

// ========================================
// USERS - –°–∏—Å—Ç–µ–º–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
// ========================================

model User {
  id String @id @default(cuid())

  // Tenant Isolation - –ö–†–ò–¢–ò–ß–ù–û!
  tenantId String?
  tenant   Tenant? @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Auth Info
  email                 String  @unique
  password              String // bcrypt hash
  passwordAutoGenerated Boolean @default(false) @map("password_auto_generated")
  passwordResetToken     String?   @unique @map("password_reset_token")
  passwordResetExpiresAt DateTime? @map("password_reset_expires_at")

  // Personal Info
  firstName String
  lastName  String
  phone     String?
  avatar    String?

  // Role & Permissions
  role UserRole @default(CLIENT)

  // Staff Settings (for staff members)
  color      String? // Personal color for calendar (hex)
  isActive   Boolean @default(true)
  isBookable Boolean @default(true) // –ú–æ–∂–Ω–æ –ª–∏ –∑–∞–ø–∏—Å—ã–≤–∞—Ç—å –∫ —ç—Ç–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é (–≤–ª–∞–¥–µ–ª–µ—Ü/–∞–¥–º–∏–Ω –º–æ–≥—É—Ç –±—ã—Ç—å –Ω–µ-–º–∞—Å—Ç–µ—Ä–∞–º–∏)

  // Issue #82: Staff Specialization & Languages (updated for multi-select)
  specializations StaffSpecializationType[] @default([]) // Multi-select: ["BARBER", "STYLIST"]
  languages       String[]                  @default([]) // JSON array: ["PL", "EN", "RU"]

  // Status
  status        EntityStatus @default(PENDING)
  emailVerified Boolean      @default(false)

  // Auth Tokens
  devices       Device[]
  refreshTokens RefreshToken[]

  // MFA (Multi-Factor Authentication) - –¥–ª—è SUPER_ADMIN
  mfaEnabled     Boolean @default(false)
  mfaSecret      String? // TOTP secret (encrypted)
  mfaBackupCodes String? // JSON array of hashed backup codes

  // Relationships
  createdAppointments  Appointment[]          @relation("AppointmentCreatedBy")
  assignedAppointments Appointment[]          @relation("AppointmentAssignedTo")
  appointmentStaff     AppointmentStaff[]     @relation("AppointmentStaff") // NEW: Issue #80
  servicesAvailable    StaffServiceMap[]      @relation("StaffServices") // NEW: Issue #82
  sentInvitations      Invitation[]           @relation("InviterInvitations")
  salonAccess          UserSalonAccess[]
  notifications        Notification[]
  notificationSettings NotificationSettings[]

  // Multi-Tenant Relationships (NEW - –¥–ª—è multi-role –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã)
  ownedTenants  TenantOwner[] // –°–∞–ª–æ–Ω—ã, –∫–æ—Ç–æ—Ä—ã–º–∏ –≤–ª–∞–¥–µ–µ—Ç user
  tenantRoles   UserTenantRole[] // –†–æ–ª–∏ user –≤ —Ä–∞–∑–Ω—ã—Ö tenant
  clientProfile ClientProfile? // –ü—Ä–æ—Ñ–∏–ª—å –∫–ª–∏–µ–Ω—Ç–∞ (–µ—Å–ª–∏ user - –∫–ª–∏–µ–Ω—Ç)

  // Schedule Management (Issue #73)
  staffWorkingHours       StaffWorkingHour[]       @relation("StaffWorkingHours")
  staffScheduleExceptions StaffScheduleException[] @relation("StaffScheduleExceptions")

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("users")
}

// JWT Refresh Tokens
model RefreshToken {
  id        String    @id @default(cuid())
  token     String    @unique
  userId    String
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  deviceId  String
  device    Device    @relation(fields: [deviceId], references: [id], onDelete: Cascade)
  isUsed    Boolean   @default(false)
  usedAt    DateTime?
  expiresAt DateTime
  createdAt DateTime  @default(now())

  @@index([userId])
  @@index([deviceId])
  @@index([expiresAt])
  @@map("refresh_tokens")
}

model Device {
  id            String         @id @default(cuid())
  userId        String
  user          User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  deviceId      String
  userAgent     String?
  ipAddress     String?
  deviceName    String?
  isActive      Boolean        @default(true)
  lastUsedAt    DateTime       @default(now())
  createdAt     DateTime       @default(now())
  refreshTokens RefreshToken[]

  @@unique([userId, deviceId])
  @@map("devices")
}

model Permission {
  id          String  @id @default(cuid())
  name        String  @unique
  description String?
  category    String
  roles       Role[]

  @@map("permissions")
}

model Role {
  id          String       @id @default(cuid())
  name        String       @unique
  description String?
  permissions Permission[]

  @@map("roles")
}

// ========================================
// MULTI-TENANT ROLE SYSTEM (NEW)
// ========================================
// –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤:
// - –û–¥–∏–Ω email = –º–Ω–æ–∂–µ—Å—Ç–≤–æ —Ä–æ–ª–µ–π –≤ —Ä–∞–∑–Ω—ã—Ö —Å–∞–ª–æ–Ω–∞—Ö
// - –í–ª–∞–¥–µ–ª–µ—Ü —Å–µ—Ç–∏ —Å–∞–ª–æ–Ω–æ–≤
// - –ö–ª–∏–µ–Ω—Ç + –í–ª–∞–¥–µ–ª–µ—Ü + –°–æ—Ç—Ä—É–¥–Ω–∏–∫ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ

// –í–ª–∞–¥–µ–Ω–∏–µ —Å–∞–ª–æ–Ω–∞–º–∏ (Many-to-Many: User ‚Üî Tenant)
model TenantOwner {
  id String @id @default(cuid())

  // Relationships
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  userId   String
  user     User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Ownership Details
  isPrimary Boolean @default(false) // –ì–ª–∞–≤–Ω—ã–π –≤–ª–∞–¥–µ–ª–µ—Ü (–¥–ª—è –≤—ã–±–æ—Ä–∞ primary contact)
  share     Int?    @default(100) // –î–æ–ª—è –≤–ª–∞–¥–µ–Ω–∏—è –≤ % (–¥–ª—è co-ownership)

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([tenantId, userId])
  @@index([userId])
  @@index([tenantId])
  @@map("tenant_owners")
}

// –†–æ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ tenant
model UserTenantRole {
  id String @id @default(cuid())

  // Relationships
  userId   String
  user     User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Role Details
  role     TenantRole // OWNER, MANAGER, STAFF, RECEPTIONIST, ACCOUNTANT
  isActive Boolean    @default(true)

  // Audit Trail
  grantedAt DateTime  @default(now())
  grantedBy String? // User ID –∫—Ç–æ –≤—ã–¥–∞–ª —Ä–æ–ª—å
  revokedAt DateTime?
  revokedBy String? // User ID –∫—Ç–æ –æ—Ç–æ–∑–≤–∞–ª —Ä–æ–ª—å

  @@unique([userId, tenantId, role])
  @@index([userId])
  @@index([tenantId])
  @@index([userId, isActive])
  @@map("user_tenant_roles")
}

// ========================================
// CLIENTS - –ö–ª–∏–µ–Ω—Ç—ã —Å–∞–ª–æ–Ω–æ–≤ (LEGACY)
// ========================================
// NOTE: –≠—Ç–æ legacy –º–æ–¥–µ–ª—å –¥–ª—è —Å—Ç–∞—Ä–æ–π —Å–∏—Å—Ç–µ–º—ã.
// –ù–æ–≤–∞—è –≥–ª–æ–±–∞–ª—å–Ω–∞—è –∫–ª–∏–µ–Ω—Ç—Å–∫–∞—è —Å–∏—Å—Ç–µ–º–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç ClientProfile + ClientSalonRelation

model Client {
  id String @id @default(cuid())

  // Tenant Isolation
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Personal Info
  name  String
  email String?
  phone String?

  // Additional Info
  notes    String?
  birthday DateTime?

  // Status
  status EntityStatus @default(ACTIVE)

  // Relationships
  appointments Appointment[]

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([tenantId, email])
  @@index([tenantId, phone]) // Index –¥–ª—è fraud detection (–Ω–µ unique!)
  @@map("clients")
}

// ========================================
// CLIENT PORTAL SYSTEM - –ì–ª–æ–±–∞–ª—å–Ω–∞—è –∫–ª–∏–µ–Ω—Ç—Å–∫–∞—è —Å–∏—Å—Ç–µ–º–∞ (Issue #31)
// ========================================
// –î–æ–±–∞–≤–ª–µ–Ω–æ: 05.10.2025
// Email-based multi-tenant client management –¥–ª—è Client Portal

// Gender –¥–ª—è –∫–ª–∏–µ–Ω—Ç–æ–≤
enum Gender {
  MALE // –ú—É–∂—Å–∫–æ–π
  FEMALE // –ñ–µ–Ω—Å–∫–∏–π
  OTHER // –î—Ä—É–≥–æ–π
  PREFER_NOT_TO_SAY // –ü—Ä–µ–¥–ø–æ—á–∏—Ç–∞—é –Ω–µ —É–∫–∞–∑—ã–≤–∞—Ç—å
}

// Loyalty Tiers - 4 —É—Ä–æ–≤–Ω—è –ø—Ä–æ–≥—Ä–∞–º–º—ã –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏
enum LoyaltyTier {
  BRONZE // 0-999 points
  SILVER // 1000-4999 points
  GOLD // 5000-9999 points
  PLATINUM // 10000+ points
}

// Client Source - –æ—Ç–∫—É–¥–∞ –ø—Ä–∏—à–µ–ª –∫–ª–∏–µ–Ω—Ç
enum ClientSource {
  GOOGLE_OAUTH // Google OAuth —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
  WALK_IN // Walk-in –∫–ª–∏–µ–Ω—Ç (—Å–æ–∑–¥–∞–Ω —Å–∞–ª–æ–Ω–æ–º)
  REFERRAL // –ü–æ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å—Å—ã–ª–∫–µ
  INSTAGRAM // –ò–∑ Instagram
  FACEBOOK // –ò–∑ Facebook
  WEBSITE // –° –≤–µ–±-—Å–∞–π—Ç–∞ —Å–∞–ª–æ–Ω–∞
  OTHER // –î—Ä—É–≥–æ–π –∏—Å—Ç–æ—á–Ω–∏–∫
}

// –ì–ª–æ–±–∞–ª—å–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å –∫–ª–∏–µ–Ω—Ç–∞ (email = primary key)
model ClientProfile {
  email String @id @unique // –ì–ª–æ–±–∞–ª—å–Ω—ã–π —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä

  // Personal Info
  firstName String
  lastName  String
  avatar    String?

  // Phone Verification (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –ø–æ—Å–ª–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏)
  phone           String?
  phoneVerified   Boolean   @default(false)
  phoneVerifiedAt DateTime? @map("phone_verified_at")

  // Personal Data
  birthdate DateTime? // –î–ª—è birthday campaigns
  gender    Gender?

  // OAuth Integration
  googleId String? @unique @map("google_id") // Google OAuth ID

  // Authentication (–¥–ª—è email/password —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏)
  password String? @map("password") // Bcrypt hash (null –¥–ª—è OAuth-only –∫–ª–∏–µ–Ω—Ç–æ–≤)

  // User Account Link (NEW - –¥–ª—è multi-role –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã)
  // –°–≤—è–∑—å —Å User account (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è - –º–æ–∂–µ—Ç –±—ã—Ç—å null –¥–ª—è legacy –∫–ª–∏–µ–Ω—Ç–æ–≤)
  userId String? @unique @map("user_id")
  user   User?   @relation(fields: [userId], references: [id], onDelete: SetNull)

  // Platform Tracking
  joinedPortalAt DateTime      @default(now()) @map("joined_portal_at") // –ü–µ—Ä–≤–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
  source         ClientSource? // –ò—Å—Ç–æ—á–Ω–∏–∫ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
  referredBy     String?       @map("referred_by") // Email –∫–ª–∏–µ–Ω—Ç–∞-—Ä–µ—Ñ–µ—Ä–µ—Ä–∞

  // Referral Program
  referralCode  String? @unique @map("referral_code") // –£–Ω–∏–∫–∞–ª—å–Ω—ã–π —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –∫–æ–¥ (–Ω–∞–ø—Ä–∏–º–µ—Ä: ANNA2024)
  referralCount Int     @default(0) @map("referral_count") // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–Ω—ã—Ö –¥—Ä—É–∑–µ–π

  // Preferences
  preferredLanguage Language @default(RU) @map("preferred_language")
  marketingConsent  Boolean  @default(false) @map("marketing_consent") // GDPR compliance

  // Status
  isActive Boolean      @default(true) @map("is_active")
  status   EntityStatus @default(ACTIVE)

  // Relationships
  salonRelations ClientSalonRelation[] // –°–≤—è–∑—å —Å —Å–∞–ª–æ–Ω–∞–º–∏ (–º–Ω–æ–≥–∏–µ-–∫–æ-–º–Ω–æ–≥–∏–º)
  notifications  ClientNotification[] // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–≥–æ –ø–æ—Ä—Ç–∞–ª–∞

  // Audit
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([googleId])
  @@index([referralCode])
  @@index([source])
  @@map("client_profiles")
}

// –°–≤—è–∑—å –∫–ª–∏–µ–Ω—Ç–∞ —Å —Å–∞–ª–æ–Ω–æ–º (–º–Ω–æ–≥–∏–µ-–∫–æ-–º–Ω–æ–≥–∏–º —Å –¥–æ–ø. –¥–∞–Ω–Ω—ã–º–∏)
model ClientSalonRelation {
  id String @id @default(cuid())

  // –°–≤—è–∑–∏
  clientEmail String        @map("client_email") // Email –∫–ª–∏–µ–Ω—Ç–∞
  client      ClientProfile @relation(fields: [clientEmail], references: [email], onDelete: Cascade)

  tenantId String @map("tenant_id") // ID —Å–∞–ª–æ–Ω–∞
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Salon-specific Notes
  salonNotes String? @map("salon_notes") @db.Text // –ó–∞–º–µ—Ç–∫–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Å–∞–ª–æ–Ω–∞ –æ –∫–ª–∏–µ–Ω—Ç–µ

  // Visit Tracking
  visitCount    Int       @default(0) @map("visit_count") // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–∏–∑–∏—Ç–æ–≤
  lastVisitAt   DateTime? @map("last_visit_at") // –ü–æ—Å–ª–µ–¥–Ω–∏–π –≤–∏–∑–∏—Ç
  joinedSalonAt DateTime  @default(now()) @map("joined_salon_at") // –î–∞—Ç–∞ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –∫ —Å–∞–ª–æ–Ω—É

  // Loyalty System (salon-specific)
  loyaltyTier   LoyaltyTier @default(BRONZE) @map("loyalty_tier")
  loyaltyPoints Int         @default(0) @map("loyalty_points") // –ë–∞–ª–ª—ã –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏ (100 points = ‚Ç¨1)
  totalSpent    Decimal     @default(0) @map("total_spent") @db.Decimal(10, 2) // –û–±—â–∞—è —Å—É–º–º–∞ –ø–æ—Ç—Ä–∞—á–µ–Ω–Ω–∞—è

  // Status
  isActive  Boolean @default(true) @map("is_active") // –ê–∫—Ç–∏–≤–µ–Ω –ª–∏ –≤ –¥–∞–Ω–Ω–æ–º —Å–∞–ª–æ–Ω–µ
  isPrimary Boolean @default(false) @map("is_primary") // –û—Å–Ω–æ–≤–Ω–æ–π —Å–∞–ª–æ–Ω –∫–ª–∏–µ–Ω—Ç–∞

  // Audit
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([clientEmail, tenantId]) // –ö–ª–∏–µ–Ω—Ç –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—Ä–∏–≤—è–∑–∞–Ω –∫ —Å–∞–ª–æ–Ω—É —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑
  @@index([tenantId, loyaltyTier]) // –î–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ loyalty tier
  @@index([tenantId, lastVisitAt]) // –î–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –ø–æ –ø–æ—Å–ª–µ–¥–Ω–µ–º—É –≤–∏–∑–∏—Ç—É
  @@index([clientEmail])
  @@map("client_salon_relations")
}

// –ü—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–æ–≤ –∫ —Å–∞–ª–æ–Ω–∞–º
model ClientInvitation {
  id String @id @default(cuid())

  // –°–∞–ª–æ–Ω, –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–∏–≥–ª–∞—à–∞–µ—Ç –∫–ª–∏–µ–Ω—Ç–∞
  tenantId String @map("tenant_id")
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // –î–∞–Ω–Ω—ã–µ –ø—Ä–∏–≥–ª–∞—à–∞–µ–º–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞
  clientEmail String  @map("client_email")
  clientPhone String? @map("client_phone")
  clientName  String? @map("client_name") // –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ

  // Invitation Details
  invitedBy       String? @map("invited_by") // Email —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ —Å–∞–ª–æ–Ω–∞
  personalMessage String? @map("personal_message") @db.Text

  // Bonus –¥–ª—è –ø–µ—Ä–≤–æ–≥–æ –≤–∏–∑–∏—Ç–∞
  firstVisitBonus    Int?     @map("first_visit_bonus") // Bonus loyalty points
  firstVisitDiscount Decimal? @map("first_visit_discount") @db.Decimal(5, 2) // –°–∫–∏–¥–∫–∞ –≤ %

  // –°—Ç–∞—Ç—É—Å –∏ —Ç–æ–∫–µ–Ω—ã
  status    InviteStatus @default(PENDING)
  token     String       @unique @default(cuid()) // –£–Ω–∏–∫–∞–ª—å–Ω—ã–π —Ç–æ–∫–µ–Ω –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è
  expiresAt DateTime     @map("expires_at") // –°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è (30 –¥–Ω–µ–π)

  // Timestamps
  createdAt  DateTime  @default(now()) @map("created_at")
  sentAt     DateTime? @map("sent_at")
  acceptedAt DateTime? @map("accepted_at")
  declinedAt DateTime? @map("declined_at")

  @@index([tenantId, status])
  @@index([clientEmail])
  @@index([token])
  @@map("client_invitations")
}

model SalonInviteCode {
  id String @id @default(cuid())

  tenantId String @map("tenant_id")
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  code String @unique

  createdBy  String?   @map("created_by")
  maxUses    Int?      @map("max_uses")
  usageCount Int       @default(0) @map("usage_count")
  expiresAt  DateTime? @map("expires_at")
  lastUsedAt DateTime? @map("last_used_at")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([tenantId])
  @@map("salon_invite_codes")
}

// ========================================
// SERVICES & CATEGORIES - –£—Å–ª—É–≥–∏ —Å–∞–ª–æ–Ω–∞
// ========================================

model ServiceCategory {
  id            String               @id @default(cuid())
  tenantId      String
  tenant        Tenant               @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  name          String
  icon          String?
  order         Int                  @default(0)
  isDefault     Boolean              @default(false)
  isActive      Boolean              @default(true)
  subcategories ServiceSubcategory[]
  services      Service[]
  createdAt     DateTime             @default(now())
  updatedAt     DateTime             @updatedAt

  @@unique([tenantId, name])
  @@index([tenantId, order])
  @@map("service_categories")
}

model ServiceSubcategory {
  id         String          @id @default(cuid())
  categoryId String
  category   ServiceCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  name       String
  order      Int             @default(0)
  isDefault  Boolean         @default(false)
  isActive   Boolean         @default(true)
  services   Service[]
  createdAt  DateTime        @default(now())
  updatedAt  DateTime        @updatedAt

  @@unique([categoryId, name])
  @@index([categoryId, order])
  @@map("service_subcategories")
}

model Service {
  id String @id @default(cuid())

  // Tenant Isolation
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Service Info
  name          String
  description   String?
  duration      Int // –í –º–∏–Ω—É—Ç–∞—Ö
  price         Decimal             @db.Decimal(10, 2)
  isDefault     Boolean             @default(false)
  isActive      Boolean             @default(true)
  categoryId    String?
  category      ServiceCategory?    @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  subcategoryId String?
  subcategory   ServiceSubcategory? @relation(fields: [subcategoryId], references: [id], onDelete: SetNull)

  // Status
  status EntityStatus @default(ACTIVE)

  // Relationships
  appointments        Appointment[]
  appointmentServices AppointmentService[] @relation("AppointmentServices")
  staffAvailable      StaffServiceMap[]    @relation("StaffServices") // NEW: Issue #82

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId, categoryId])
  @@index([tenantId, subcategoryId])
  @@map("services")
}

// ========================================
// STAFF SERVICES - Issue #82: M:N Junction Table
// ========================================

model StaffServiceMap {
  id String @id @default(cuid())

  // Tenant Isolation - –ö–†–ò–¢–ò–ß–ù–û!
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Staff ‚Üî Service relationship
  staffId String
  staff   User   @relation("StaffServices", fields: [staffId], references: [id], onDelete: Cascade)

  serviceId String
  service   Service @relation("StaffServices", fields: [serviceId], references: [id], onDelete: Cascade)

  // Optional metadata
  notes    String?
  isActive Boolean @default(true)

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Constraints
  @@unique([tenantId, staffId, serviceId]) // Prevent duplicate staff-service per tenant
  @@index([tenantId])
  @@index([staffId])
  @@index([serviceId])
  @@map("staff_service_map")
}

// ========================================
// APPOINTMENTS - –ó–∞–ø–∏—Å–∏
// ========================================

enum AppointmentStatus {
  PENDING // –û–∂–∏–¥–∞–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
  CONFIRMED // –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞
  IN_PROGRESS // –í –ø—Ä–æ—Ü–µ—Å—Å–µ
  COMPLETED // –ó–∞–≤–µ—Ä—à–µ–Ω–∞
  CANCELLED // –û—Ç–º–µ–Ω–µ–Ω–∞
  NO_SHOW // –ù–µ –ø—Ä–∏—à–µ–ª
}

enum PaymentMethod {
  CARD
  CASH
}

enum PaymentStatus {
  PENDING
  SUCCEEDED
  FAILED
  CANCELLED
}

model Appointment {
  id                String @id @default(cuid())
  appointmentNumber String // –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –Ω–æ–º–µ—Ä –∑–∞–ø–∏—Å–∏

  // Tenant Isolation
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Appointment Info
  date    DateTime // –î–∞—Ç–∞ –∑–∞–ø–∏—Å–∏
  startAt DateTime // –í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ (UTC)
  endAt   DateTime // –í—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è (–≤—ã—á–∏—Å–ª—è–µ—Ç—Å—è –∏–∑ —Å—É–º–º–∞—Ä–Ω–æ–π –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏)

  // Relationships
  clientId String
  client   Client @relation(fields: [clientId], references: [id], onDelete: Restrict)

  // LEGACY - –¥–ª—è backward compatibility (–º–∏–≥—Ä–∞—Ü–∏—è –ø–æ-–Ω–æ–≤–æ–º—É)
  serviceId String?
  service   Service? @relation(fields: [serviceId], references: [id], onDelete: SetNull)

  // NEW - Multiple Services Support (Issue #79)
  appointmentServices AppointmentService[] @relation("AppointmentServices")

  // Calculated fields from services
  totalDuration Int     @default(0) // –°—É–º–º–∞ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–µ–π –≤—Å–µ—Ö —É—Å–ª—É–≥ (–≤ –º–∏–Ω—É—Ç–∞—Ö)
  totalPrice    Decimal @default(0) @db.Decimal(10, 2) // –°—É–º–º–∞ —Ü–µ–Ω –≤—Å–µ—Ö —É—Å–ª—É–≥
  currency      String  @default("PLN") // –í–∞–ª—é—Ç–∞ (–∏–∑ —É—Å–ª—É–≥)

  // LEGACY - –¥–ª—è backward compatibility (–º–∏–≥—Ä–∞—Ü–∏—è –ø–æ-–Ω–æ–≤–æ–º—É)
  assignedToId String?
  assignedTo   User?   @relation("AppointmentAssignedTo", fields: [assignedToId], references: [id], onDelete: SetNull)

  // NEW - Multiple Staff Support (Issue #80)
  staffMembers AppointmentStaff[] @relation("AppointmentStaff")

  // Status & Notes
  status AppointmentStatus @default(PENDING)
  notes  String?

  // Payments
  paymentMethod PaymentMethod @default(CASH)
  paymentStatus PaymentStatus @default(PENDING)
  paymentId     String?
  payment       Payment?      @relation("AppointmentPayment")

  // Audit Trail
  createdById String?
  createdBy   User?   @relation("AppointmentCreatedBy", fields: [createdById], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([tenantId, appointmentNumber])
  @@index([tenantId, startAt]) // –î–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞ –ø–æ –¥–∞—Ç–∞–º
  @@map("appointments")
}

// ========================================
// APPOINTMENT SERVICES - –ú–Ω–æ–≥–∏–µ-–∫–æ-–º–Ω–æ–≥–∏–º (Issue #79)
// ========================================
// Snapshot —É—Å–ª—É–≥ –≤ –º–æ–º–µ–Ω—Ç —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–ø–∏—Å–∏ (–¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏ —Ü–µ–Ω –∏ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏)

model AppointmentService {
  id String @id @default(cuid())

  // Relationships
  appointmentId String
  appointment   Appointment @relation("AppointmentServices", fields: [appointmentId], references: [id], onDelete: Cascade)

  serviceId String // –°—Å—ã–ª–∫–∞ –Ω–∞ Service (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–∞, –µ—Å–ª–∏ —É—Å–ª—É–≥–∞ –±—ã–ª–∞ —É–¥–∞–ª–µ–Ω–∞)
  service   Service? @relation("AppointmentServices", fields: [serviceId], references: [id], onDelete: SetNull)

  // Snapshot fields (—Å–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –Ω–∞ –º–æ–º–µ–Ω—Ç —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–ø–∏—Å–∏)
  name     String // –ù–∞–∑–≤–∞–Ω–∏–µ —É—Å–ª—É–≥–∏ (snapshot)
  price    Decimal @db.Decimal(10, 2) // –¶–µ–Ω–∞ –≤ –º–æ–º–µ–Ω—Ç –∑–∞–ø–∏—Å–∏ (snapshot)
  duration Int // –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤ –º–∏–Ω—É—Ç–∞—Ö (snapshot)
  currency String  @default("PLN") // –í–∞–ª—é—Ç–∞ —É—Å–ª—É–≥–∏

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([appointmentId, serviceId])
  @@index([appointmentId])
  @@index([serviceId])
  @@map("appointment_services")
}

// ========================================
// APPOINTMENT STAFF - –ú–Ω–æ–≥–∏–µ-–∫–æ-–º–Ω–æ–≥–∏–º (Issue #80)
// ========================================
// M:N junction —Ç–∞–±–ª–∏—Ü–∞ –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –º–∞—Å—Ç–µ—Ä–æ–≤ –Ω–∞ –∑–∞–ø–∏—Å—å

model AppointmentStaff {
  id String @id @default(cuid())

  // Relationships
  appointmentId String
  appointment   Appointment @relation("AppointmentStaff", fields: [appointmentId], references: [id], onDelete: Cascade)

  staffId String
  staff   User   @relation("AppointmentStaff", fields: [staffId], references: [id], onDelete: Restrict)

  // Staff role/position in this appointment (for future expansion)
  role String? // "primary", "assistant", "trainer"

  // Order/sequence (for sorting multiple staff)
  sequenceOrder Int @default(0)

  // Status tracking
  confirmedAt DateTime? @map("confirmed_at") // When staff confirmed the appointment
  confirmedBy String?   @map("confirmed_by") // Staff self-confirmation vs owner-assigned

  // Audit
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([appointmentId, staffId]) // Prevent duplicate staff per appointment
  @@index([appointmentId])
  @@index([staffId])
  @@map("appointment_staff")
}

// ========================================
// STAFF INVITATION SYSTEM
// ========================================

// –°—Ç–∞—Ç—É—Å—ã –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–π
enum InviteStatus {
  PENDING // –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ, –∂–¥–µ–º –æ—Ç–≤–µ—Ç–∞
  ACCEPTED // –ü—Ä–∏–Ω—è—Ç–æ –º–∞—Å—Ç–µ—Ä–æ–º
  DECLINED // –û—Ç–∫–ª–æ–Ω–µ–Ω–æ –º–∞—Å—Ç–µ—Ä–æ–º
  EXPIRED // –ò—Å—Ç–µ–∫ —Å—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è
  REVOKED // –û—Ç–æ–∑–≤–∞–Ω–æ –≤–ª–∞–¥–µ–ª—å—Ü–µ–º —Å–∞–ª–æ–Ω–∞
}

// –ü—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è –¥–ª—è –º–∞—Å—Ç–µ—Ä–æ–≤
model Invitation {
  id String @id @default(cuid())

  // –°–∞–ª–æ–Ω, –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–∏–≥–ª–∞—à–∞–µ—Ç
  tenantId      String
  tenant        Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  inviterUserId String // –ö—Ç–æ –æ—Ç–ø—Ä–∞–≤–∏–ª –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ
  inviter       User   @relation("InviterInvitations", fields: [inviterUserId], references: [id], onDelete: Cascade)

  // –î–∞–Ω–Ω—ã–µ –ø—Ä–∏–≥–ª–∞—à–∞–µ–º–æ–≥–æ –º–∞—Å—Ç–µ—Ä–∞
  masterEmail     String
  masterPhone     String?
  masterName      String
  personalMessage String? // –õ–∏—á–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –≤–ª–∞–¥–µ–ª—å—Ü–∞

  // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–æ—Å—Ç—É–ø–∞
  role        UserRole @default(STAFF_MEMBER)
  permissions String[] @default(["calendar.view", "appointments.manage"])

  // –°—Ç–∞—Ç—É—Å –∏ —Ç–æ–∫–µ–Ω—ã
  status    InviteStatus @default(PENDING)
  token     String       @unique @default(cuid())
  expiresAt DateTime // –°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è (7 –¥–Ω–µ–π)

  // –°–≤—è–∑—å —Å —Å–æ–∑–¥–∞–Ω–Ω—ã–º –¥–æ—Å—Ç—É–ø–æ–º
  userSalonAccess UserSalonAccess[]

  // Timestamps
  createdAt  DateTime  @default(now())
  sentAt     DateTime?
  acceptedAt DateTime?
  declinedAt DateTime?

  @@map("invitations")
}

// –°–≤—è–∑—å –º–∞—Å—Ç–µ—Ä-—Å–∞–ª–æ–Ω (–º–Ω–æ–≥–∏–µ-–∫–æ-–º–Ω–æ–≥–∏–º)
model UserSalonAccess {
  id String @id @default(cuid())

  // –°–≤—è–∑–∏
  userId   String
  user     User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // –ü—Ä–∞–≤–∞ –∏ —Ä–æ–ª–∏
  role        UserRole
  permissions String[] // –î–µ—Ç–∞–ª—å–Ω—ã–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è
  isOwner     Boolean  @default(false) // –í–ª–∞–¥–µ–ª–µ—Ü —Å–∞–ª–æ–Ω–∞
  isActive    Boolean  @default(true) // –ê–∫—Ç–∏–≤–Ω—ã–π —Å–æ—Ç—Ä—É–¥–Ω–∏–∫

  // –°–≤—è–∑—å —Å –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ–º
  invitationId String? // –°—Å—ã–ª–∫–∞ –Ω–∞ –∏—Å—Ö–æ–¥–Ω–æ–µ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ
  invitation   Invitation? @relation(fields: [invitationId], references: [id], onDelete: SetNull)

  // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ä–∞–±–æ—Ç—ã
  priority       Int     @default(1) // –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç —Å–∞–ª–æ–Ω–∞ (1 = –æ—Å–Ω–æ–≤–Ω–æ–π)
  canSeeFinances Boolean @default(false) // –î–æ—Å—Ç—É–ø –∫ —Ñ–∏–Ω–∞–Ω—Å–∞–º
  workingHours   Json? // –†–∞–±–æ—á–∏–µ —á–∞—Å—ã –≤ –¥–∞–Ω–Ω–æ–º —Å–∞–ª–æ–Ω–µ

  // Timestamps
  createdAt    DateTime @default(now())
  lastActiveAt DateTime @default(now())

  @@unique([userId, tenantId])
  @@map("user_salon_access")
}

// ========================================
// NOTIFICATION CENTER
// ========================================

enum NotificationType {
  EMAIL
  SMS
  PUSH
  IN_APP
  WEBHOOK
}

enum NotificationStatus {
  PENDING
  SENT
  DELIVERED
  FAILED
  READ
}

enum NotificationPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

model Notification {
  id String @id @default(cuid())

  tenantId String  @map("tenant_id")
  tenant   Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  userId String    @map("user_id")
  user   User?     @relation(fields: [userId], references: [id], onDelete: Cascade)

  type     NotificationType
  title    String
  message  String
  metadata Json?

  priority NotificationPriority @default(MEDIUM)
  status   NotificationStatus   @default(PENDING)

  sentAt      DateTime? @map("sent_at")
  deliveredAt DateTime? @map("delivered_at")
  readAt      DateTime? @map("read_at")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([tenantId, userId])
  @@index([tenantId, status])
  @@map("notifications")
}

model NotificationSettings {
  id String @id @default(cuid())

  tenantId String @map("tenant_id")
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  userId String @map("user_id")
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  emailEnabled  Boolean @default(true)  @map("email_enabled")
  smsEnabled    Boolean @default(true)  @map("sms_enabled")
  pushEnabled   Boolean @default(true)  @map("push_enabled")

  appointmentReminders Boolean @default(true)  @map("appointment_reminders")
  promotionalEmails    Boolean @default(false) @map("promotional_emails")
  systemNotifications  Boolean @default(true)  @map("system_notifications")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([tenantId, userId])
  @@index([tenantId])
  @@map("notification_settings")
}

// ========================================
// IMAGES - Tenant-isolated File Storage
// ========================================

model Image {
  id       String @id @default(cuid())
  tenantId String @map("tenant_id")
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  entityType String @map("entity_type")
  entityId   String? @map("entity_id")

  filename     String
  originalName String @map("original_name")
  mimeType     String @map("mime_type")
  size         Int

  path         String
  url          String
  thumbnailUrl String? @map("thumbnail_url")
  originalUrl  String  @map("original_url")

  displayName String? @map("display_name")
  altText     String? @map("alt_text")
  width       Int?
  height      Int?

  optimizedSize Int? @map("optimized_size")
  uploadedBy    String? @map("uploaded_by")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([tenantId, entityType])
  @@index([tenantId, entityId])
  @@index([tenantId, createdAt])
  @@map("images")
}

// ========================================
// SCHEDULE MANAGEMENT (Issue #73-74)
// ========================================

enum ScheduleExceptionType {
  DAY_OFF
  SICK_LEAVE
  CUSTOM_HOURS
}

model SalonWorkingHour {
  id String @id @default(cuid())

  tenantId String
  tenant   Tenant @relation("SalonWorkingHours", fields: [tenantId], references: [id], onDelete: Cascade)

  dayOfWeek Int @default(0)
  startTime String @map("start_time")
  endTime   String @map("end_time")
  isWorkingDay Boolean @default(true) @map("is_working_day")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([tenantId, dayOfWeek])
  @@index([tenantId])
  @@map("salon_working_hours")
}

model StaffWorkingHour {
  id String @id @default(cuid())

  tenantId String
  tenant   Tenant @relation("StaffWorkingHours", fields: [tenantId], references: [id], onDelete: Cascade)

  staffId String
  staff   User   @relation("StaffWorkingHours", fields: [staffId], references: [id], onDelete: Cascade)

  dayOfWeek Int @default(0)
  startTime String @map("start_time")
  endTime   String @map("end_time")
  isWorkingDay Boolean @default(true) @map("is_working_day")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([staffId, dayOfWeek])
  @@index([tenantId])
  @@map("staff_working_hours")
}

model StaffScheduleException {
  id String @id @default(cuid())

  tenantId String
  tenant   Tenant @relation("StaffScheduleExceptions", fields: [tenantId], references: [id], onDelete: Cascade)

  staffId String?
  staff   User?  @relation("StaffScheduleExceptions", fields: [staffId], references: [id], onDelete: Cascade)

  startDate DateTime @map("start_date")
  endDate   DateTime @map("end_date")
  type      ScheduleExceptionType

  customStartTime String?  @map("custom_start_time")
  customEndTime   String?  @map("custom_end_time")
  isWorkingDay    Boolean? @map("is_working_day")
  reason          String?
  createdBy       String? @map("created_by")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([tenantId])
  @@index([staffId])
  @@index([startDate])
  @@index([endDate])
  @@map("staff_schedule_exceptions")
}

// ========================================
// CLIENT PORTAL NOTIFICATIONS
// ========================================

enum ClientNotificationType {
  APPOINTMENT_CONFIRMED
  APPOINTMENT_REMINDER
  APPOINTMENT_CANCELLED
  APPOINTMENT_RESCHEDULED
  LOYALTY_POINTS_EARNED
  LOYALTY_TIER_UPGRADED
  BIRTHDAY_REWARD
  REFERRAL_BONUS
  MARKETING_PROMOTION
  PAYMENT_RECEIPT
}

model ClientNotification {
  id          String                 @id @default(cuid())
  clientEmail String                 @map("client_email")
  type        ClientNotificationType
  priority    NotificationPriority   @default(MEDIUM)
  title       String
  message     String                 @db.Text
  metadata    Json?

  readAt      DateTime? @map("read_at")
  deliveredAt DateTime? @map("delivered_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  expiresAt   DateTime? @map("expires_at")

  client ClientProfile @relation(fields: [clientEmail], references: [email], onDelete: Cascade)

  @@index([clientEmail, readAt])
  @@index([clientEmail, createdAt])
  @@map("client_notifications")
}


// ========================================
// AUDIT & LOGGING
// ========================================

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  LOGIN
  LOGOUT
  REFRESH_TOKEN
  EXPORT
  IMPORT
}

model AuditLog {
  id String @id @default(cuid())

  // Tenant Context
  tenantId String?

  // Action Info
  action     AuditAction
  entityType String // "User", "Appointment", etc.
  entityId   String? // ID —Å—É—â–Ω–æ—Å—Ç–∏

  // User Context
  userId   String?
  userRole UserRole?

  // Changes
  oldValues Json? // –°—Ç–∞—Ä—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
  newValues Json? // –ù–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è

  // Technical Info
  ipAddress String?
  userAgent String?

  // Timestamp
  createdAt DateTime @default(now())

  @@map("audit_logs")
}

// ========================================
// PAYMENT SERVICE - Stage 5 Models
// ========================================

// üí∞ –ü–ª–∞—Ç–µ–∂–∏ –∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
model Payment {
  id       String @id @default(cuid())
  tenantId String @map("tenant_id") // üîê –ö–†–ò–¢–ò–ß–ù–û: Tenant isolation

  // Provider data (generic)
  provider   String // stripe, paypal, etc.
  providerId String? @map("provider_id") // Provider's payment ID

  // Customer reference
  customerId String? @map("customer_id") // –ë–î –∏—Å–ø–æ–ª—å–∑—É–µ—Ç snake_case

  // –°—É–º–º–∞ –∏ –≤–∞–ª—é—Ç–∞ (integer in cents/units)
  amount   Int // Amount in cents/units
  currency String @default("EUR") // EUR, PLN, USD

  // –°—Ç–∞—Ç—É—Å
  status String // PENDING, SUCCEEDED, FAILED, CANCELLED

  // Metadata
  metadata  Json? // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –æ—Ç Provider
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  appointmentId String?        @unique @map("appointment_id")
  appointment   Appointment?   @relation("AppointmentPayment", fields: [appointmentId], references: [id], onDelete: SetNull)
  refunds       Refund[] // Payment can have multiple refunds
  events        PaymentEvent[] // Payment can have multiple events
  invoiceEmails InvoiceEmail[] // Payment can have multiple invoice emails

  // Subscription Relation
  subscriptionId String?       @map("subscription_id")
  subscription   Subscription? @relation(fields: [subscriptionId], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([status])
  @@map("payments")
}

// üßæ –ò–Ω–≤–æ–π—Å—ã –¥–ª—è PDF –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
model Invoice {
  id             String  @id @default(cuid())
  tenantId       String  @map("tenant_id") // üîê –ö–†–ò–¢–ò–ß–ù–û: Tenant isolation
  subscriptionId String?
  paymentId      String?

  // –ù–æ–º–µ—Ä –∏–Ω–≤–æ–π—Å–∞
  invoiceNumber String @unique

  // –°—É–º–º—ã
  subtotal    Decimal @db.Decimal(10, 2)
  taxAmount   Decimal @default(0) @db.Decimal(10, 2)
  totalAmount Decimal @db.Decimal(10, 2)
  currency    String  @default("EUR")

  // –ü–µ—Ä–∏–æ–¥—ã
  periodStart DateTime
  periodEnd   DateTime
  dueDate     DateTime

  // –°—Ç–∞—Ç—É—Å
  status String // DRAFT, SENT, PAID, OVERDUE, CANCELLED

  // PDF
  pdfUrl String? // URL –∫ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–º—É PDF

  // Metadata
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([tenantId])
  @@index([subscriptionId])
  @@index([invoiceNumber])
  @@index([status])
  @@map("invoices")
}

// üîÑ –í–æ–∑–≤—Ä–∞—Ç—ã —Å—Ä–µ–¥—Å—Ç–≤ (Stage 5)
model Refund {
  id        String @id @default(cuid())
  tenantId  String @map("tenant_id") // üîê –ö–†–ò–¢–ò–ß–ù–û: Tenant isolation
  paymentId String @map("payment_id") // Reference to Payment

  // Provider refund data
  provider         String // "stripe" | "paypal"
  providerRefundId String? @map("provider_refund_id") // Provider's refund ID

  // Amount and currency
  amount   Int // Amount in cents/units
  currency String @default("EUR")

  // Status tracking
  status String  @default("pending") // pending, succeeded, failed
  reason String? // Optional refund reason

  // Metadata
  metadata  Json? // Additional provider data
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  payment Payment?       @relation(fields: [paymentId], references: [id], onDelete: Cascade)
  events  PaymentEvent[] // For webhook deduplication

  @@index([tenantId])
  @@index([paymentId])
  @@index([providerRefundId])
  @@index([status])
  @@map("refunds")
}

// üìß Email delivery tracking (Stage 5)
model InvoiceEmail {
  id        String @id @default(uuid())
  tenantId  String @map("tenant_id") // üîê –ö–†–ò–¢–ò–ß–ù–û: Tenant isolation
  paymentId String @map("payment_id") // Reference to Payment

  // Email data
  to      String // Recipient email address
  subject String? // Email subject
  status  String  @default("queued") // queued | sent | failed

  // Provider response
  providerResponse Json? @map("provider_response") // Provider response data

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  payment Payment @relation(fields: [paymentId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([paymentId])
  @@index([status])
  @@map("invoice_emails")
}

// üìù Payment events for webhook deduplication (Stage 5)
model PaymentEvent {
  id       String  @id @default(cuid())
  tenantId String? @map("tenant_id") // Optional: events can be global

  // Provider event data
  provider  String // "stripe" | "paypal"
  eventType String @map("event_type") // Provider event type
  eventId   String @unique @map("event_id") // Provider event ID (for deduplication)

  // Related entities
  paymentId String? @map("payment_id") // Optional payment reference
  refundId  String? @map("refund_id") // Optional refund reference

  // Event payload
  payload   Json // Full webhook payload
  processed Boolean @default(false)

  // Metadata
  receivedAt DateTime @default(now()) @map("received_at")

  // Relations
  payment Payment? @relation(fields: [paymentId], references: [id], onDelete: SetNull)
  refund  Refund?  @relation(fields: [refundId], references: [id], onDelete: SetNull)

  @@index([eventId]) // For fast deduplication lookup
  @@index([provider, eventType])
  @@index([paymentId])
  @@index([refundId])
  @@map("payment_events")
}

// üîë Idempotency keys for API requests (24h TTL)
model IdempotencyKey {
  key         String   @id // Client-provided idempotency key (primary key in DB)
  tenantId    String   @map("tenant_id") // Tenant isolation
  requestHash String   @map("request_hash") // SHA256 of request data
  response    Json // Cached response
  expiresAt   DateTime @map("expires_at") // Auto-cleanup after 24h
  createdAt   DateTime @default(now()) @map("created_at")

  @@index([tenantId]) // Tenant filtering
  @@index([expiresAt]) // For cleanup queries
  @@map("idempotency_keys")
}

// ========================================
// SUBSCRIPTIONS - –ú–æ–¥–µ–ª—å –ø–æ–¥–ø–∏—Å–æ–∫ (B2B)
// ========================================

enum SubscriptionStatus {
  TRIAL
  ACTIVE
  PAST_DUE
  CANCELED
  UNPAID
}

enum SubscriptionPlan {
  BASIC
  PRO
  ENTERPRISE
}

model Subscription {
  id        String   @id @default(cuid())
  tenantId  String   @unique @map("tenant_id")
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  plan      SubscriptionPlan @default(BASIC)
  status    SubscriptionStatus @default(TRIAL)
  currency  Currency          @default(PLN)
  
  stripeCustomerId String? @map("stripe_customer_id")
  stripeSubscriptionId String? @map("stripe_subscription_id")

  basePriceCents      Int       @default(10000) @map("base_price_cents")
  staffSeatPriceCents Int       @default(2500)  @map("staff_seat_price_cents")
  staffSeatCount      Int       @default(0)     @map("staff_seat_count")
  discountPercent     Int       @default(0)     @map("discount_percent")
  discountEndsAt      DateTime? @map("discount_ends_at")
  netAmountCents      Int       @default(0)     @map("net_amount_cents")
  grossAmountCents    Int       @default(0)     @map("gross_amount_cents")
  vatRateBps          Int       @default(2300)  @map("vat_rate_bps")
  pastDueSince        DateTime? @map("past_due_since")
  gracePeriodEndsAt   DateTime? @map("grace_period_ends_at")
  lastBillingDate     DateTime? @map("last_billing_date")
  lastWarningSentAt   DateTime? @map("last_warning_sent_at")
  
  currentPeriodStart DateTime @default(now()) @map("current_period_start")
  currentPeriodEnd   DateTime? @map("current_period_end")
  
  cancelAtPeriodEnd Boolean @default(false) @map("cancel_at_period_end")
  canceledAt        DateTime? @map("canceled_at")
  
  trialEndsAt       DateTime? @map("trial_ends_at")
  
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  
  payments  Payment[] // Relation to payments

  @@map("subscriptions")
}
