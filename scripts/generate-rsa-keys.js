#!/usr/bin/env node

/**
 * Generate RSA keys and store in database
 * Simple Node.js script (no TS compilation needed)
 */

const crypto = require('crypto');
const { PrismaClient } = require('@prisma/client');
const path = require('path');
const fs = require('fs').promises;

const prisma = new PrismaClient();

async function generateRSAKeyPair() {
  const { publicKey, privateKey } = crypto.generateKeyPairSync('rsa', {
    modulusLength: 2048,
    publicKeyEncoding: {
      type: 'spki',
      format: 'pem'
    },
    privateKeyEncoding: {
      type: 'pkcs8',
      format: 'pem'
    }
  });

  const timestamp = Date.now().toString(36);
  const random = crypto.randomBytes(8).toString('hex');
  const kid = `beautysvc_${timestamp}_${random}`;

  return { publicKey, privateKey, kid };
}

async function saveKeysToFile(publicKey, privateKey, kid) {
  try {
    const keysDir = path.join(process.cwd(), 'keys');
    await fs.mkdir(keysDir, { recursive: true });

    // Save private key (PROTECTED)
    const privateKeyPath = path.join(keysDir, `rsa_private_${kid}.pem`);
    await fs.writeFile(privateKeyPath, privateKey, { mode: 0o600 });

    // Save public key
    const publicKeyPath = path.join(keysDir, `rsa_public_${kid}.pem`);
    await fs.writeFile(publicKeyPath, publicKey);

    // Save metadata
    const metadataPath = path.join(keysDir, `rsa_metadata_${kid}.json`);
    await fs.writeFile(
      metadataPath,
      JSON.stringify(
        {
          kid,
          algorithm: 'RS256',
          use: 'sig',
          createdAt: new Date().toISOString(),
          privateKeyPath,
          publicKeyPath
        },
        null,
        2
      )
    );

    console.log(`âœ… Keys saved to ${keysDir}`);
    return { privateKeyPath, publicKeyPath, metadataPath };
  } catch (error) {
    console.error('âŒ Failed to save keys to file:', error);
    throw error;
  }
}

async function main() {
  console.log('\nğŸ”‘ Starting RSA Key Generation...\n');

  try {
    // Check existing keys
    const existingKeys = await prisma.rSAKey.findMany({
      where: { status: 'ACTIVE' }
    });

    if (existingKeys.length > 0) {
      console.log(`âš ï¸  Found ${existingKeys.length} existing active key(s)`);
      console.log('   Keys:', existingKeys.map(k => k.kid));
      const forceFlag = process.argv.includes('--force');
      if (!forceFlag) {
        console.log('\n   Use --force flag to add more keys\n');
        return;
      }
    }

    // Generate new key pair
    console.log('ğŸ” Generating RSA-2048 key pair...');
    const { publicKey, privateKey, kid } = await generateRSAKeyPair();
    console.log(`âœ… Generated key with kid: ${kid}\n`);

    // Save to filesystem
    console.log('ğŸ’¾ Saving keys to filesystem backup...');
    const filePaths = await saveKeysToFile(publicKey, privateKey, kid);

    // Save to database
    console.log('ğŸ“ Saving to database...');
    const rSAKey = await prisma.rSAKey.create({
      data: {
        kid,
        algorithm: 'RS256',
        publicKey,
        privateKey,
        status: 'ACTIVE',
        use: 'sig',
        issuedBy: 'seed-script',
        metadata: {
          version: '1.0',
          environment: process.env.NODE_ENV || 'development',
          note: 'Initial key generated by seed script'
        }
      }
    });

    console.log(`âœ… Saved to database with ID: ${rSAKey.id}\n`);

    // Output configuration info
    console.log('ğŸ“‹ Configuration Information:');
    console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
    console.log(`Key ID (kid):        ${kid}`);
    console.log(`Algorithm:           RS256`);
    console.log(`Status:              ${rSAKey.status}`);
    console.log(`Use:                 ${rSAKey.use}`);
    console.log(`Created At:          ${rSAKey.createdAt.toISOString()}`);
    console.log(`Database ID:         ${rSAKey.id}`);
    console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');

    console.log('\nğŸ“‚ File Locations:');
    console.log(`  Private Key:       ${filePaths.privateKeyPath}`);
    console.log(`  Public Key:        ${filePaths.publicKeyPath}`);
    console.log(`  Metadata:          ${filePaths.metadataPath}`);

    console.log('\nğŸ” Environment Variables to Set:');
    console.log(`  RSA_KID=${kid}`);
    console.log(`  RSA_ALGORITHM=RS256`);

    console.log('\nâœ… RSA Key Generation Complete!\n');

    // Security warning
    console.log('âš ï¸  SECURITY REMINDERS:');
    console.log('  1. Store private key securely (AWS KMS, Vault, etc.)');
    console.log('  2. Never commit private keys to git');
    console.log('  3. Add keys/ directory to .gitignore');
    console.log('  4. Rotate keys every 90 days');
    console.log('  5. Keep last 3 keys for verification during rotation\n');
  } catch (error) {
    console.error('âŒ Error:', error);
    process.exit(1);
  } finally {
    await prisma.$disconnect();
  }
}

main();
